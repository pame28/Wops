import { Component, OnInit } from '@angular/core';
import { FormBuilder, FormGroup, Validators, ReactiveFormsModule } from '@angular/forms';
import { CommonModule } from '@angular/common';
import Swal from 'sweetalert2';
import { SideBarComponent } from '../../../../shared/side-bar/side-bar';
import { MantenimientoLayoutComponent } from '../../../../shared/mantenimiento-layout/mantenimiento-layout';
import { MantenimientoModalComponent } from '../../../../shared/mantenimiento-modal/mantenimiento-modal';
import { PuestosTrabajoService } from './services/puestos-trabajo.service';
import { AreasService } from '../areas/services/areas.service';
import { Observable, map, startWith } from 'rxjs';
import { MatFormFieldModule } from '@angular/material/form-field';
import { MatInputModule } from '@angular/material/input';
import { MatAutocompleteModule } from '@angular/material/autocomplete';
import { MatIconModule } from '@angular/material/icon';

interface Area {
  id: string | number;
  nombre: string;
}

@Component({
  selector: 'app-puestos-trabajo',
  standalone: true,
  imports: [
    CommonModule,
    ReactiveFormsModule,
    SideBarComponent,
    MantenimientoLayoutComponent,
    MantenimientoModalComponent,
    MatFormFieldModule,
    MatInputModule,
    MatAutocompleteModule,
    MatIconModule
  ],
  templateUrl: './puestos-trabajo.component.html',
  styleUrls: ['./puestos-trabajo.component.css'],
})
export class PuestosTrabajoComponent implements OnInit {

  puestosTrabajo: any[] = [];
  puestoTrabajoForm!: FormGroup;
  showCard = false;
  editMode = false;
  currentId: string | null = null;
  isSidebarCollapsed = false;

  // Autocomplete control
  areaCtrl = this.fb.control('', Validators.required);
  selectedAreaId: string | null = null;
  areas: Area[] = [];
  filteredAreas!: Observable<Area[]>;

  columns = [
    { field: 'id', header: 'ID' },
    { field: 'nombre', header: 'Nombre' },
    { field: 'areaNombre', header: 'Área' }
  ];

  constructor(
    private fb: FormBuilder,
    private puestosTrabajoService: PuestosTrabajoService,
    private areasService: AreasService
  ) {}

  ngOnInit(): void {
    this.puestoTrabajoForm = this.fb.group({
      nombre: ['', Validators.required],
      areaId: ['', Validators.required]
    });

    this.loadAreas();
    this.loadPuestosTrabajo();

    // Sincronizar área seleccionada
    this.areaCtrl.valueChanges.subscribe(value => {
      const match = this.areas.find(a => a.nombre === value);
      this.selectedAreaId = match ? match.id.toString() : null;
      this.puestoTrabajoForm.get('areaId')?.setValue(this.selectedAreaId || '');
    });
  }

  // Mostrar nombre de la área en el input
  displayArea(areaName: string) {
    return areaName || '';
  }

  loadAreas() {
    this.areasService.getAreas().subscribe({
      next: resp => {
        this.areas = (resp as any).data ?? resp;

        this.filteredAreas = this.areaCtrl.valueChanges.pipe(
          startWith(''),
          map(value => {
            const filterValue = (value || '').toLowerCase();
            return this.areas.filter(area => area.nombre.toLowerCase().includes(filterValue));
          })
        );
      },
      error: () => Swal.fire('Error', 'No se pudieron cargar las áreas', 'error')
    });
  }

  loadPuestosTrabajo() {
    this.puestosTrabajoService.getPuestosTrabajo().subscribe({
      next: resp => {
        this.puestosTrabajo = (resp as any).data ?? resp;
        this.mapAreaNombre();
      },
      error: () => Swal.fire('Error', 'No se pudieron cargar los puestos', 'error')
    });
  }

  private mapAreaNombre() {
    if (!this.puestosTrabajo.length || !this.areas.length) return;
    this.puestosTrabajo = this.puestosTrabajo.map(p => {
      const area = this.areas.find(a => a.id.toString() === p.areaId?.toString());
      return { ...p, areaNombre: area?.nombre || `ID ${p.areaId}` };
    });
  }

  openCreateCard() {
    this.editMode = false;
    this.currentId = null;
    this.puestoTrabajoForm.reset({ nombre: '', areaId: '' });
    this.areaCtrl.setValue('');
    this.selectedAreaId = null;
    this.showCard = true;
  }

  openEditCard(puestoTrabajo: any) {
    this.editMode = true;
    this.currentId = puestoTrabajo.id;
    const areaName = this.areas.find(a => a.id.toString() === puestoTrabajo.areaId?.toString())?.nombre || '';

    this.puestoTrabajoForm.setValue({
      nombre: puestoTrabajo.nombre,
      areaId: puestoTrabajo.areaId
    });

    this.areaCtrl.setValue(areaName);
    this.selectedAreaId = puestoTrabajo.areaId?.toString() || null;
    this.showCard = true;
  }

  closeCard() {
    this.showCard = false;
  }

  savePuestoTrabajo() {
    if (this.puestoTrabajoForm.invalid) {
      this.puestoTrabajoForm.markAllAsTouched();
      return;
    }

    const body = {
      nombre: this.puestoTrabajoForm.value.nombre,
      areaId: this.selectedAreaId
    };

    let request$;
    if (this.editMode && this.currentId) {
      request$ = this.puestosTrabajoService.actualizarPuestoTrabajo(this.currentId, { id: this.currentId, ...body });
    } else {
      request$ = this.puestosTrabajoService.crearPuestoTrabajo(body);
    }

    request$.subscribe({
      next: () => {
        Swal.fire('Éxito', this.editMode ? 'Puesto actualizado' : 'Puesto creado', 'success');
        this.loadPuestosTrabajo();
        this.closeCard();
      },
      error: () => Swal.fire('Error', 'No se pudo guardar', 'error')
    });
  }

  deletePuestoTrabajo(id: string) {
    Swal.fire({
      title: '¿Eliminar Puesto de Trabajo?',
      icon: 'warning',
      showCancelButton: true,
      confirmButtonText: 'Eliminar'
    }).then(res => {
      if (res.isConfirmed) {
        this.puestosTrabajoService.eliminarPuestoTrabajo(id).subscribe({
          next: () => {
            Swal.fire('Eliminado', 'Puesto eliminado', 'success');
            this.loadPuestosTrabajo();
          }
        });
      }
    });
  }

  onSidebarToggled(state: boolean) {
    this.isSidebarCollapsed = state;
  }

  clearArea() {
    this.areaCtrl.setValue('');
    this.selectedAreaId = null;
    this.puestoTrabajoForm.get('areaId')?.setValue('');
  }
}
